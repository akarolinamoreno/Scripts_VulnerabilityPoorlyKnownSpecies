#rm(list=ls())

options(java.parameters = "-Xmx1g" )
library(raster)
library(maps)
library(dismo)
library(adehabitatHS)
library(data.table)
library(Rfast)
library(vegan)
library(rJava)
library(kernlab)
library(Rfast)


dir.climaPres <- "/Volumes/..."
dir.clima2070 <- "/Volumes/..."
dir.ocor <- "/Users/..."
dir.output <- "/Users/..."


AOGCMs <- c("cc60bi70","hd60bi70","mr60bi70")

setwd(dir.ocor)
ocor <- read.table("ocor.txt", h=T)


climaPres <- stack(paste(dir.climaPres, paste("PC", 1:6, " #Pres.tif", sep=""), sep= "/"))
names(climaPres) <- paste("PC", 1:6, sep="")
coord <- rasterToPoints(climaPres[[1]])[,1:2]
bkg <- coord[sample(1:nrow(coord), 10000), ]
combClima <- data.frame(a= c(1,1,1,1,1,2,2,2,2,3,3,3,4,4,5), b= c(2,3,4,5,6,3,4,5,6,4,5,6,5,6,6))
	

#selecting species with 3 or more points
spp <- levels(ocor[,"species"])
ocor1 <- NULL
spp1 <- NULL
for(i in 1:length(spp)){
	coord.sp <- ocor[ocor[,"species"]==spp[i],2:3]
	sp.val <- extract(climaPres, coord.sp, cellnumber=T)
	id.dup <- duplicated(sp.val[,"cells"])
	coord.sp <- coord.sp[which(id.dup==FALSE),]

	ocor1 <- rbind(ocor1, data.frame(species= spp[i], coord.sp))
	spp1 <- rbind(spp1, data.frame(species= spp[i], PtsTotal= nrow(sp.val), PtsUnicos= nrow(coord.sp)))
}#end for'i'
rm(i)
ocor <- ocor1
#id.spp.mais4 <- which(spp1[,"PtsUnicos"]>3)

spp.menos3 <- spp1[which(spp1[,"PtsUnicos"] <= 3), "species"]
spp.3_25pts <- spp1[which(spp1[,"PtsUnicos"] >= 3 & spp1[,"PtsUnicos"] <= 25), "species"]
rm(spp, spp1, coord.sp, sp.val, id.dup, sp.val, ocor1)


#############################################################################

#############    ENMs  #######################

#########################################################################

#ENMs for less 3 occ.
climaPres <- stack(paste(dir.climaPres, paste("PC", 1:6, " #Pres.tif", sep=""), sep= "/"))
names(climaPres) <- paste("PC", 1:6, sep="")
sp= spp.menos3[1]
for(sp in spp.menos3){
  #
  coord.sp <- ocor[ocor[,1]==sp,2:3]
  #
  for(j in 1:nrow(combClima)){
  
    #outPres <- outFut <- NULL
    #pegar valores pres
    climaPres.comb <- climaPres[[ combClima[j,] ]]
    climaPres.val <- na.omit(values(climaPres.comb))
    #extrair valores de sp presente
    sp.val <- extract(climaPres.comb, coord.sp)
    #se 2 pontos, fazer media (sp.val)
    if(nrow(sp.val) > 1){ sp.val <- matrix(colMeans(sp.val), nrow=1, dimnames= list(c(), c(colnames(sp.val)))) }
    #calcular dist para pres 
    distPres <- as.numeric(dista(xnew= sp.val, x= climaPres.val)[1,])*-1
    
    setwd(dir.output)  
    writeRaster(rasterFromXYZ(cbind(coord, distPres)), paste("Out1. OrigModel_Comb", j," (", sp, ") #EuclDist_Pres.tif", sep=""), format= "GTiff", overwrite=T )
    
    
      aogcm <- AOGCMs[1]
      for(aogcm in AOGCMs){
    
        climaFut <- stack(paste(dir.clima2070, aogcm, paste("PC", 1:6, " #", aogcm,".tif", sep=""), sep= "/"))
        names(climaFut) <- paste("PC", 1:6, sep="")
        climaFut.comb <- climaFut[[ combClima[j,] ]]
        climaFut.val <- na.omit(values(climaFut.comb))
        
        distFut <- as.numeric(dista(xnew= sp.val, x= climaFut.val)[1,])*-1
        
        setwd(dir.output)
        writeRaster(rasterFromXYZ(cbind(coord, distFut)), paste("Out1. OrigModel_Comb", j," (", sp, ") #EuclDist_", aogcm, ".tif", sep=""), format= "GTiff", overwrite=T )
        
    
      }#end for (aogcm)
  
  }#end for (j)
  
}#end for (sp)




# Ensemble Present

  for(sp in spp.menos3){

    setwd(dir.output)
    Map.pres <- stack(paste("Out1. OrigModel_Comb", 1:15," (", sp, ") #EuclDist_Pres.tif", sep=""))
    ENMvals <- data.frame(na.omit(values(Map.pres)))
    ENMvals <- apply(ENMvals, 1, mean)
    Ens.pres <- stack(rasterFromXYZ(cbind(coord, ENMvals)))
    writeRaster(Ens.pres, paste("Out4. ParcEnsemble (", sp, ") #EucliDist_Pres.tif", sep=""), format= "GTiff", overwrite=T)

  } #end for (sp)  



# Ensemble Future

  setwd(dir.output)

  for(sp in spp.menos3){
    
    aogcm= AOGCMs[1]
    for(aogcm in AOGCMs){
      Map.fut <- stack(paste("Out1. OrigModel_Comb", 1:15," (", sp, ") #EucliDist_", aogcm, ".tif", sep=""))
      ENMvals <- data.frame(na.omit(values(Map.fut)))
      ENMvals <- apply(ENMvals, 1, mean)
      Ens.fut <- stack(rasterFromXYZ(cbind(coord, ENMvals)))
      writeRaster(Ens.fut, paste("Out4. ParcEnsemble (", sp, ") #EucliDist_",aogcm,".tif", sep=""), format= "GTiff", overwrite=T)
      
    }#end for (rcp)
    
  }#end for (sp)  
  
  
