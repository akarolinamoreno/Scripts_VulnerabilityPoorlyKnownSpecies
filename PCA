#PCA fut - reads the mean, sd, and PCA coefficients from the present to project PCA for the future

#mediaSD: name of the file (data.frame) with the vectors of MEAN (1st column) and SD (2nd column) of the present environmental variables
#PCAcoefs: name of the file (data.frame) with the PCA coefficients for the present
Dir: directory with the mediaSD and PCAcoefs files
#DirF: Directory with the future environmental variables (tif _ worldClim model)
#e: spatial extent of the study area/background to crop the future maps

#Save (Y/N): If Save=='Y', it will save the axes that explain 95% of the variance (currently in the same folder as the original future variables)


rm(list=ls())


PCAfut<-function(mediaSD = "a-Media_SD.txt",
                 PCAcoefs = "a_Coeficientes PCApres.txt",
                 Dir = "/Volumes/...",
                 DirF = "/Volumes/...",
                 e = c(-65, -34, -35, 0),
                 nEixos = 6,
                 output= " #cc60bi70"){
  
  library(raster)
  
  #Project the PCA for future variables
  means <- read.table(paste(Dir, mediaSD, sep="/"), h=T)[,1]
  stds <- read.table(paste(Dir, mediaSD, sep="/"), h=T)[, 2]
  Coef <- read.table(paste(Dir, PCAcoefs, sep="/"), h=T)
  
  files <- paste(DirF, list.files(DirF, pattern='.tif'), sep="/")
  files <- c(files[1], files[12:19], files[2:11])
  ProjT<- stack(files)
  ProjT<- crop(ProjT, extent(e))
  
  ProjE<-rasterToPoints(ProjT)
  ProjE<-na.omit(ProjE)
  ProjER <-ProjE[,-c(1:2)]
  
  scale<-sweep(ProjER,2,means)
  scale<-scale %*% diag(1/stds)
  PCAFut<-NULL
  
  for (x in 1:nEixos){
    CoefPC<-as.numeric(Coef[,x])
    PC<-scale %*% CoefPC
    PCAFut <- cbind(PCAFut,PC)
  }
  colnames(PCAFut) <- colnames(Coef)[1: nEixos]
  PCAFut <- data.frame(cbind(ProjE[,(1:2)],PCAFut))
  gridded(PCAFut)<- ~x+y
  PCAFut<-stack(PCAFut)

  writeRaster(PCAFut, paste(DirF, paste(names(PCAFut), output, sep=""), sep="/"), bylayer=T, format="GTiff", overwrite=T)
 
}#ends function "PCAfut"


###############################################
#########

		
PCAfut(	mediaSD = "a-Media_SD.txt",
		PCAcoefs = "a_Coeficientes PCApres.txt",
		Dir = "/Volumes/.../wc2.0_30s",
		e = c(-65, -34, -35, 0),
		nEixos = 6,
		DirF = "/Volumes/.../cc60bi70",
		output= " #cc60bi50")

		
PCAfut(	mediaSD = "a-Media_SD.txt",
		PCAcoefs = "a_Coeficientes PCApres.txt",
		Dir = "/Volumes/.../wc2.0_30s",
		e = c(-65, -34, -35, 0),
		nEixos = 6,
		DirF = "/Volumes/.../hd60bi70",
		output= " #hd60bi50")


PCAfut(	mediaSD = "a-Media_SD.txt",
		PCAcoefs = "a_Coeficientes PCApres.txt",
		Dir = "/Volumes/.../wc2.0_30s",
		e = c(-65, -34, -35, 0),
		nEixos = 6,
		DirF = "/Volumes/.../mr26bi70",
		output= " #mr60bi70")






