rm(list=ls())
library(vegan)

setwd("F:/")


# Adaptive capacity (ac)
# Column 1 refers to the species name and Column 2 refers to the body size
ac <- read.csv("AC - body size.csv")
ac <- data.frame(Scpecie= ac[,"Scpecie"], ac= decostand(ac[,"body_size"], "range", 2))


# Exposure (ex)

# Biotic velocity 
# For more details on how to calculate biotic velocity (foward velocity), refer to the supplementary material of Hamann, A. et al. 2015. Velocity of climate change algorithms for guiding conservation and management. Glob. Chang. Biol. 21, 997–1004. https://doi.org/10.1111/gcb.12736
#  Column 1 refers to the species name and Column 2 refers to mean habitat tracking for foward velocity (RCP 6.0)
ex1 <- read.csv("Ex - HabitatTrackingMean.csv")
ex1 <- data.frame(Scpecie= ex1[,"Scpecie"], ex1= decostand(ex1[,"for60"], "range", 2))

  
# Range Shift
ex2 <- read.csv("Ex - Range Shift.csv")
ex2 <- data.frame(Scpecie= ex2[,1], rcp= ex2[,4], propRS= ex2[,"lost"]/ex2[,"lost.stable"])
spp <- data.frame(Scpecie= sort(unique(ex2[,1])))
rs <- function(ex2, sp){
	rs.mean60 <- mean(ex2[ex2[,"Scpecie"]==sp & ex2[,"rcp"]=="RCP60", "propRS"])
	return(rs60= rs.mean60)
}
ex2 <- data.frame(Scpecie= spp, t(apply(spp, 1, function(x) rs(ex2, x))) )
ex2 <- data.frame(Scpecie= ex2[,"Scpecie"], ex2= decostand(ex2[,"rs60"], "range", 2))

  
# Representativeness in protected areas 
# For more details on how to calculate SRI, refer to the paper Alagador, D. et al. 2011. A probability-based approach to match species with reserves when data are at different resolutions. Biol. Conserv. 144, 811–820. https://doi.org/10.1016/j.biocon.2010.11.011
ex3 <- read.csv("Ex - SRI.csv")
ex3 <- data.frame(Scpecie= ex3[,1], rcp= ex3[,4], SRI= ex3[,"sri_back"])
spp <- data.frame(Scpecie= sort(unique(ex3[,1])))
sri <- function(ex3, sp){
	sri.mean60 <- mean(ex3[ex3[,"Scpecie"]==sp & ex3[,"rcp"]=="RCP60", "SRI"])
	return(sri60= sri.mean60)
}

  
ex3 <- data.frame(Scpecie= spp, t(apply(spp, 1, function(x) sri(ex3, x))) )
ex3 <- data.frame(Scpecie= ex3[,"Scpecie"], ex3= decostand(ex3[,"sri60"]*(-1), "range", 2))

ex <- data.frame(Scpecie= ex1[,1], ex= decostand(ex1[,2]+ex2[,2]+ex3[,2], "range", 2))


# Sensititivity (se)

#Climatic zones 
#Overlay occurrence points with Köppen climate zones
se1 <- read.csv("Se - climatic zone koppen.csv")
se1 <- data.frame(Scpecie= se1[,"Scpecie"], se1= decostand(se1[,"Koppen"]*(-1), "range", 2))

# Climatic tolerance
se2 <- read.csv("Se - niche length.csv")
se2 <- data.frame(Scpecie= se2[,"Scpecie"], se2= decostand(se2[,"soma"]*(-1), "range", 2))

# Range size 
se3 <- read.csv("Se - range size (Pts Scpecies).csv")
se3 <- data.frame(Scpecie= se3[,"Scpecie"], se3= decostand(se3[,"PtsUnicos"]*(-1), "range", 2))

# Reproductive mode 
se4 <- read.csv("Se - reproductive mode.csv")
se4 <- data.frame(Scpecie= se4[,"Scpecies"], se4= se4[,"Reproductive_mode.1"])

se <- data.frame(Scpecie= se1[,1], se= decostand(se1[,2]+se2[,2]+se3[,2]+se4[,2], "range", 2))



class1 <- data.frame(Scpecie= ac[,1], Class1= (ac[,2] <= quantile(ac[,2], 0.5) & se[,2] >= quantile(se[,2], 0.5) & ex[,2] >= quantile(ex[,2], 0.5)))
class2 <- data.frame(Scpecie= ac[,1], Class2= (ac[,2] > quantile(ac[,2], 0.5) & se[,2] >= quantile(se[,2], 0.5) & ex[,2] >= quantile(ex[,2], 0.5)))
class3 <- data.frame(Scpecie= ac[,1], Class3= (ac[,2] <= quantile(ac[,2], 0.5) & se[,2] < quantile(se[,2], 0.5) & ex[,2] >= quantile(ex[,2], 0.5)))
class4 <- data.frame(Scpecie= ac[,1], Class4= (ac[,2] <= quantile(ac[,2], 0.5) & se[,2] >= quantile(se[,2], 0.5) & ex[,2] < quantile(ex[,2], 0.5)))

vul <- data.frame(Scpecie= ac[,1], ac= ac[,2] >= quantile(ac[,2], 0.5), se= se[,2] >= quantile(se[,2], 0.5), ex= ex[,2] >= quantile(ex[,2], 0.5))

tabela <- cbind(spp,Class1[,2],Class2[,2],Class3[,2],Class4[,2],vul[2:4])
colnames(tabela) <- c("Scpecie","Highly vulnerable", "Potential Adapters", "Potential Persisters", "High Latent Risk", "Low Adaptative Capacity", "Sensitive", "Exposure")
write.table(tabela, paste("VulnerablScpecies.txt"), sep="\t", row.names=F)

